{% extends 'user_dashboard/base.html' %}
{% load static %}
{% load filters_user %}

{% block navbar_address %}

<li class="breadcrumb-item">
    <a href="{% url 'user-product-detail' book.book_id %}">Product Detail</a></li>

<li class="breadcrumb-item">
    <a href="index.html">{{book.title}}</a></li>

{% endblock navbar_address %}
{% block content %}

<style>
.container-audio {
    width: 66%;
    height: auto;
    padding: 20px;
    border-radius: 5px;
    background-color: #eee;
    color: #444;
    margin: 20px auto;
    overflow: hidden;
        text-align: center;

}
audio {
  width:100%;
}
audio:nth-child(2), audio:nth-child(4), audio:nth-child(6) {
    margin: 0;
}
.container-audio .colum1 {
    width: 23px;
    height: 5em;
    border-radius: 5px;
    margin: 0 10px 0 0;
    display: inline-block;
    position: relative;
}
.container-audio .colum1:last-child {
    margin: 0;
}
.container-audio .colum1 .row {
    width: 100%;
    height: 100%;
    border-radius: 5px;
    background: linear-gradient(to up, #7700aa, #8800ff);
    position: absolute;
    -webkit-animation: Rofa 10s infinite ease-in-out;
    animation: Rofa 10s infinite ease-in-out;
    bottom: 0;
}
.container-audio .colum1:nth-of-type(1) .row {
    -webkit-animation-delay: 3.99s;
    animation-delay: 3.99s;
}
.container-audio .colum1:nth-of-type(2) .row {
    -webkit-animation-delay: 3.80s;
    animation-delay: 3.80s;
}
.container-audio .colum1:nth-of-type(3) .row {
    -webkit-animation-delay: 3.70s;
    animation-delay: 3.70s;
}
.container-audio .colum1:nth-of-type(4) .row {
    -webkit-animation-delay: 3.60s;
    animation-delay: 3.60s;
}
.container-audio .colum1:nth-of-type(5) .row {
    -webkit-animation-delay: 3.50s;
    animation-delay: 3.50s;
}
.container-audio .colum1:nth-of-type(6) .row {
    -webkit-animation-delay: 3.40s;
    animation-delay: 3.40s;
}
.container-audio .colum1:nth-of-type(7) .row {
    -webkit-animation-delay: 3.30s;
    animation-delay: 3.30s;
}
.container-audio .colum1:nth-of-type(8) .row {
    -webkit-animation-delay: 3.20s;
    animation-delay: 3.20s;
}
.container-audio .colum1:nth-of-type(9) .row {
    -webkit-animation-delay: 3.10s;
    animation-delay: 3.10s;
}
.container-audio .colum1:nth-of-type(10) .row {
    -webkit-animation-delay: 2.1s;
    animation-delay: 2.1s;
}
.container-audio .colum1:nth-of-type(11) .row {
    -webkit-animation-delay: 2.1s;
    animation-delay: 2.1s;
}
.container-audio .colum1:nth-of-type(12) .row {
    -webkit-animation-delay: 2.10s;
    animation-delay: 2.10s;
}
.container-audio .colum1:nth-of-type(13) .row {
    -webkit-animation-delay: 2.20s;
    animation-delay: 2.20s;
}
.container-audio .colum1:nth-of-type(14) .row {
    -webkit-animation-delay: 1.30s;
    animation-delay: 1.30s;
}
.container-audio .colum1:nth-of-type(15) .row {
    -webkit-animation-delay: 1.40s;
    animation-delay: 1.40s;
}
.container-audio .colum1:nth-of-type(16) .row {
    -webkit-animation-delay: 1.50s;
    animation-delay: 1.50s;
}
.container-audio .colum1:nth-of-type(17) .row {
    -webkit-animation-delay: 1.60s;
    animation-delay: 1.60s;
}
.container-audio .colum1:nth-of-type(18) .row {
    -webkit-animation-delay: 1.70s;
    animation-delay: 1.70s;
}
.container-audio .colum1:nth-of-type(19) .row {
    -webkit-animation-delay: 1.80s;
    animation-delay: 1.80s;
}
.container-audio .colum1:nth-of-type(20) .row {
    -webkit-animation-delay: 2s;
    animation-delay: 2s;
}

@-webkit-keyframes Rofa {
    0% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);
        background-color: yellow;
    }

    5% {
        height: 100%;
        -webkit-transform: translatey(15px);
        transform: translatey(15px);
        background-color: fuchsia;
    }
    10% {
        height: 90%;
        transform: translatey(0);
        -webkit-transform: translatey(0);
        background-color: bisque;
    }

    15% {
        height: 80%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    20% {
        height: 70%;
        -webkit-transform: translatey(0);
        transform: translatey(0);
        background-color: cornflowerblue;
    }
    25% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);
        background-color: cornflowerblue;
    }
    30% {
        height: 70%;
        -webkit-transform: translatey(0);
        transform: translatey(0);
        background-color: cornflowerblue;
    }
    35% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    40% {
        height: 60%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    45% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    50% {
        height: 50%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    55% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    60% {
        height: 40%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    65% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    70% {
        height: 30%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    75% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    80% {
        height: 20%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    85% {
        height: 0%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    90% {
        height: 10%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    95% {
        height: 5%;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
    100% {
        height: 0;
        -webkit-transform: translatey(0);
        transform: translatey(0);

        background-color: cornflowerblue;
    }
}









</style>

<div style="min-height: 500px; width: 100%; padding-left: 5%; text-align: revert;margin-bottom:2%">
    <div class="row" style="width: 66%;margin: 20px auto">
        <h2 style="float:left">
            {{book.title}}
        </h2>
        <div style="margin-left: 10%">
            <div class="dropdown show" style="margin-bottom: 20px">
                <a
                        class="btn btn-outlined&#45;&#45;primary dropdown-toggle"
                        href="#"
                        role="button"
                        id="dropdownMenuLink"
                        data-toggle="dropdown"
                        aria-haspopup="true"
                        aria-expanded="false"
                >
                    BookMark
                </a>

                <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">
                    {% for mark in bookmarks %}
                    <a class="dropdown-item" onclick="select_bookmark({{mark.bookmark_page_number}})">
                        {{ mark.time }}
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="input-group" style="width: 30%; margin-left:5%; height: 50px">
            <input
                    type="text"
                    class="form-control"
                    placeholder="Enter a word"
                    aria-label="Enter a word"
                    aria-describedby="basic-addon2"
                    id="search_word"
                    style="    height: auto;"
            />
            <div class="input-group-append">
                <button
                        class="btn btn-outline-secondary"
                        type="button"
                        style="box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2); padding-left: 20px;padding-right: 20px"
                        onclick="search_online()"
                        data-toggle="modal"
                        data-target="#myModal"
                >
                    Search
                </button>
            </div>
        </div>
    </div>


    <div class="container-audio">
        <audio controls loop autoplay id="audio_source">
            <source
                    type="audio/mp3">
            Your browser dose not Support the audio Tag
        </audio>
    </div>
    <div class="container-audio">
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
        <div class="colum1">
            <div class="row"></div>
        </div>
    </div>

    <div style="margin:20px auto; margin-left:17%" class="row">
        <button class="btn btn-primary" style="height: fit-content; background: #ee964b;border-color: #ee964b;"
                onclick="bookmark({{book.book_id}})">Bookmark Here
        </button>
        <textarea id="notepad" style="height: 80px; padding: 5px; margin-left: 2%; width: 55%">{{quickNote.0.QuickNote_text}}</textarea>
        <button class="btn btn-secondary"
                style="padding-left:15px; padding-right:15px; margin-left: 2%; height: fit-content;    background: #ee964b;    border-color: #ee964b;"
                onclick="save_quick_note()">Save
        </button>

    </div>


    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Word: </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div>
                        <p style="font-size: 20px">Origin:</p>
                        <p class="search-modal-origin"></p>

                        <p style="font-size: 20px">Part of Speech:</p>
                        <p class="search-modal-part-of-speech"></p>

                        <p style="font-size: 20px">Definition:</p>
                        <p class="search-modal-definition"></p>

                        <p style="font-size: 20px">Example:</p>
                        <p class="search-modal-example"></p>

                        <p style="font-size: 20px">Synonyms:</p>
                        <p class="search-modal-synonyms"></p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="top-bar-book row" style="margin-left: 16%; width: 79%">
        <div style="width: 30%; font-size: 10px">
            <button class="btn" id="prev-page" style="padding-left:18px; padding-right: 18px; font-size: 10px">
                <i class="fas fa-arrow-circle-left"></i>
                &ensp; Prev Page
            </button>
            <span class="page-info" style="margin-left: 2%; margin-right: 2%">
    Page <span id="page-num"></span> of <span id="page-count"></span>
    </span>
            <button class="btn" id="next-page" style="padding-left:18px; padding-right: 18px; font-size: 10px">
                Next Page &ensp;<i class="fas fa-arrow-circle-right"></i>
            </button>
        </div>

    </div>
    <div style="
      box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.8);
      width: 45%;
      height: 800px;
      margin-top: 20px;
      overflow:scroll;
      margin-left:17%
    ">
        <canvas id="pdf-render" style="width: 100%">

        </canvas>
    </div>
</div>

<script>
var obj = new Object();
obj.type = 'audio';
var jsonString= JSON.stringify(obj);
$.ajax({
    url: '{% url "user-get-book" book.book_id audio.audio_id %}',
    type: 'get', // This is the default though, you don't actually need to always mention it
    headers: {'Accept-Ranges': 'bytes', },
    data: {'data':jsonString},
    success: function(data) {
        $('#audio_source').attr('src',data);
        var audio = $("#audio_source");
        audio[0].pause();
        audio[0].load();
    },
    failure: function(data){}
});

function bookmark(book_id){
    var myaudio = $("#audio_source");
    var cur_time = myaudio[0].currentTime;
    let url_save_bookmark = '/save_bookmark/' + book_id + '/'+parseInt(cur_time);
    var audio_id = {{audio.audio_id}};
    $.ajax({
        url: url_save_bookmark,
        type: 'get', // This is the default though, you don't actually need to always mention it
        data: ({"chapter": audio_id }),
        success: function(data) {
            alert('Saved');
        },
        failure: function(data) {
            alert('Got an error dude');
        }
    });
}
function select_bookmark(timeStamp) {

    var audio = $("#audio_source");
        audio[0].load();
        audio[0].currentTime = parseInt(timeStamp);
        audio[0].play();
}

function search_online() {

    let word = $('#search_word').val();
    $.ajax({
        url: 'https://api.dictionaryapi.dev/api/v2/entries/en/' + word,
        type: 'get', // This is the default though, you don't actually need to always mention it
        success: function(data) {
            $('#exampleModalLabel').text('Word: '+word)
            $('.search-modal-title').text($('#search_word').val());
            $('.search-modal-origin').text(data[0].origin);
            $('.search-modal-part-of-speech').text(data[0].meanings[0].partOfSpeech);
            $('.search-modal-definition').text(data[0].meanings[0].definitions[0].definition);
            $('.search-modal-example').text(data[0].meanings[0].definitions[0].example);
            console.log((data[0].meanings[0].definitions[0].synonyms))
            var synonyms = '';
            console.log(data[0].meanings[0].definitions[0].synonyms.length)
            for(var i=0; i < data[0].meanings[0].definitions[0].synonyms.length; i++){
                synonyms = synonyms + data[0].meanings[0].definitions[0].synonyms[i]+', ';
            }
            $('.search-modal-synonyms').text(synonyms);
            $('#myModal').on('shown.bs.modal', function () {
                $('#myInput').trigger('focus')
            });
        },
        failure: function(data) {
            alert('Got an error dude');
        }
    });
}
function save_quick_note(){
    console.log($('#notepad').val())
    obj.type = 'audio';
    obj.text = $('#notepad').val();

    var jsonString= JSON.stringify(obj);

    $.ajax({
        url: "{% url 'user-save-quick-notes' book.book_id audio.audio_id %}",
        type: 'get', // This is the default though, you don't actually need to always mention it
        data: {'data':jsonString},
        success: function(data) {},
        failure: function(data){}
    });
}

var book_mark = '/get_bookmark/'+{{book.book_id}};


document.addEventListener("DOMContentLoaded", function() {
    var bookmarks = [];
    var quick_notes = [];
            $('#quiz-attempt').hide();

    var canvas = document.getElementById("pdf-render");
    var context = canvas.getContext("2d");
    var scale = 1.5;
    var originx = 0;
    var originy = 0;

    canvas.onmousewheel = function (event){
        var mousex = event.clientX - canvas.offsetLeft;
        var mousey = event.clientY - canvas.offsetTop;
        var wheel = event.wheelDelta/120;//n or -n


        //according to Chris comment
        var zoom = Math.pow(1 + Math.abs(wheel)/2 , wheel > 0 ? 1 : -1);

        context.translate(
            originx,
            originy
        );
        context.scale(zoom,zoom);
        context.translate(
            -( mousex / scale + originx - mousex / ( scale * zoom ) ),
            -( mousey / scale + originy - mousey / ( scale * zoom ) )
        );

        originx = ( mousex / scale + originx - mousex / ( scale * zoom ) );
        originy = ( mousey / scale + originy - mousey / ( scale * zoom ) );
        scale *= zoom;
    }





});


var zoom_factor = 1;
var page_number = 1;
let url_pdf = null;

$.ajax({
    url: '{% url "user-get-book-pdf" book.book_id 1 %}',
    type: 'get', // This is the default though, you don't actually need to always mention it
    data: {'data':'pdf'},
    success: function(data) {
        url_pdf = data;
        let pdfDoc = null,
            pageNum = 1,
            pageIsRendering = false,
            pageNumIsPending = null;

        const scale = 1.5,
            canvas = document.querySelector('#pdf-render'),
            ctx = canvas.getContext('2d');

        // Render the page
        const renderPage = num => {
            pageIsRendering = true;
            page_number = num;
            // Get page
            pdfDoc.getPage(num).then(page => {
                // Set scale
                const viewport = page.getViewport({
                    scale
                });
                canvas.height = viewport.height * zoom_factor;
                canvas.width = viewport.width * zoom_factor;

                const renderCtx = {
                    canvasContext: ctx,
                    viewport
                };

                page.render(renderCtx).promise.then(() => {
                    pageIsRendering = false;

                    if (pageNumIsPending !== null) {
                        renderPage(pageNumIsPending);
                        pageNumIsPending = null;
                    }
                });

                // Output current page
                document.querySelector('#page-num').textContent = num;
            });
        };

        // Check for pages rendering
        const queueRenderPage = num => {
            if (pageIsRendering) {
                pageNumIsPending = num;
            } else {
                renderPage(num);
            }
        };

        // Show Prev Page
        const showPrevPage = () => {
            if (pageNum <= 1) {
                return;
            }
            pageNum--;
            queueRenderPage(pageNum);
        };

        // Show Next Page
        const showNextPage = () => {
            if (pageNum >= pdfDoc.numPages) {
                return;
            }
            pageNum++;
            queueRenderPage(pageNum);
        };

        // Get Document
        pdfjsLib
            .getDocument(url_pdf)
            .promise.then(pdfDoc_ => {
                pdfDoc = pdfDoc_;

                document.querySelector('#page-count').textContent = pdfDoc.numPages;

                renderPage(pageNum);
            })
            .catch(err => {
                // Display error
                const div = document.createElement('div');
                div.className = 'error';
                div.appendChild(document.createTextNode(err.message));
                document.querySelector('body').insertBefore(div, canvas);
                // Remove top bar
                document.querySelector('.top-bar').style.display = 'none';
            });

        // Button Events
        document.querySelector('#prev-page').addEventListener('click', showPrevPage);
        document.querySelector('#next-page').addEventListener('click', showNextPage);
        $(document).on("click", "#zoom", function () {
            //your code
            zoom_factor = 0.5

            renderPage(page_number)

        });



    },
    failure: function(data) {
        alert('Got an error dude');
    }
});
</script>

{% endblock %}
